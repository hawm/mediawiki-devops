#!/usr/bin/env bash

set -e

usage(){
    echo "Usage:"
    echo "  ./compose [any docker-compose options or command and arguments]"
    echo
    echo "Description:"
    echo "  This is a wrapper for docker-compose toauto preface the compose file from the \$APP_ENV environment variable."
    echo
    echo "For example: " 
    echo "
    docker-compose \\
        --file docker-compose.yml \\
        --file docker-compose.\$COMPOSE_MODE_in_env_file.yml \\
        --env-file configs/\$APP_ENV.env \\
        up -d"
    echo
    echo "May be shortend as: "
    echo "
    APP_ENV=dev ./compose up -d"
    echo
}

ensure_file(){
    if [[ ! -f "$1" ]]; then
        echo "ERROR: No such file $1"
    fi
}

prepare_env(){
    env_config_file="$APP_DIR/$APP_ENV.env"
    ensure_file "$env_config_file"

    # get ENV variable from config file 
    COMPOSE_MODE=$(sed -n 's/^COMPOSE_MODE=//p' "$env_config_file")
    
    env_compose_file="$APP_DIR/docker-compose.$COMPOSE_MODE.yml"
    ensure_file "$env_compose_file"
}

execute(){
    # shellcheck disable=2086
    docker-compose \
        --file "$APP_DIR/docker-compose.yml" \
        --file "$env_compose_file" \
        --env-file "$env_config_file" \
        "$@"
}

if [ -z "$APP_DIR" ]
then
    APP_DIR=$(dirname "$(readlink -f "$0")")
fi

case "$1" in 
    -h|--help)
        usage
        exit 0
        ;;
esac

prepare_env
execute "$@"